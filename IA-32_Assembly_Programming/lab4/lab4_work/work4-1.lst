     1                                           ;代码清单15-2
     2                                           ;文件名：c15.asm
     3                                           ;文件说明：用户程序 
     4                                           ;创建日期：2011-11-15 19:11   
     5                                  
     6                                  ;===============================================================================
     7                                  SECTION header vstart=0
     8                                  
     9 00000000 [00000000]                       program_length   dd program_end          ;程序总长度#0x00
    10                                           
    11 00000004 [28030000]                       head_len         dd header_end           ;程序头部的长度#0x04
    12                                  
    13 00000008 00000000                         stack_seg        dd 0                    ;用于接收堆栈段选择子#0x08
    14 0000000C 01000000                         stack_len        dd 1                    ;程序建议的堆栈大小#0x0c
    15                                                                                    ;以4KB为单位
    16                                                                                    
    17 00000010 [00000000]                       prgentry         dd start                ;程序入口#0x10 
    18 00000014 [00000000]                       code_seg         dd section.code.start   ;代码段位置#0x14
    19 00000018 [5C000000]                       code_len         dd code_end             ;代码段长度#0x18
    20                                  
    21 0000001C [00000000]                       data_seg         dd section.data.start   ;数据段位置#0x1c
    22 00000020 [1F000000]                       data_len         dd data_end             ;数据段长度#0x20
    23                                  ;-------------------------------------------------------------------------------
    24                                           ;符号地址检索表
    25 00000024 03000000                         salt_items       dd (header_end-salt)/256 ;#0x24
    26                                           
    27                                           salt:                                     ;#0x28
    28 00000028 405072696E74537472-              PrintString      db  '@PrintString'
    29 00000031 696E67             
    30 00000034 00<rept>                                     times 256-($-PrintString) db 0
    31                                                       
    32 00000128 405465726D696E6174-              TerminateProgram db  '@TerminateProgram'
    33 00000131 6550726F6772616D   
    34 00000139 00<rept>                                     times 256-($-TerminateProgram) db 0
    35                                                       
    36 00000228 40526561644469736B-              ReadDiskData     db  '@ReadDiskData'
    37 00000231 44617461           
    38 00000235 00<rept>                                     times 256-($-ReadDiskData) db 0
    39                                                   
    40                                  header_end:
    41                                    
    42                                  ;===============================================================================
    43                                  SECTION data vstart=0                
    44                                  
    45 00000000 0D0A                             message_1        db  0x0d,0x0a
    46 00000002 312B322B332B2E2E2E-                               db  '1+2+3+...+1000=',0
    47 0000000B 2B313030303D00     
    48                                                            
    49 00000012 4F4B20202020202020-              message_2        db  'OK        ',0x0d,0x0a,0
    50 0000001B 200D0A00           
    51                                  
    52                                  data_end:
    53                                  
    54                                  ;===============================================================================
    55                                        [bits 32]
    56                                  ;===============================================================================
    57                                  SECTION code vstart=0
    58                                  start:
    59                                           ;任务启动时，DS指向头部段，也不需要设置堆栈 
    60 00000000 8CD8                             mov eax,ds
    61 00000002 8EE0                             mov fs,eax
    62                                       
    63 00000004 A1[1C000000]                     mov eax,[data_seg]
    64 00000009 8ED8                             mov ds,eax
    65                                       
    66 0000000B BB[00000000]                     mov ebx,message_1
    67 00000010 64FF1D[28000000]                 call far [fs:PrintString]
    68                                  
    69                                  ;=======================================================
    70 00000017 31C0                             xor eax,eax
    71 00000019 31C9                             xor ecx,ecx
    72                                    @@:
    73 0000001B 41                               inc ecx
    74 0000001C 01C8                             add eax,ecx
    75 0000001E 81F9E8030000                     cmp ecx,1000
    76 00000024 7CF5                             jl @@
    77                                  
    78                                  	;以下计算累加和的每个数位，存到堆栈
    79 00000026 BB0A000000                       mov ebx,10
    80 0000002B 31C9                             xor ecx,ecx
    81                                       @d:
    82 0000002D 41                               inc ecx
    83 0000002E 31D2                             xor edx,edx
    84 00000030 F7F3                             div ebx
    85 00000032 80CA30                           or dl,0x30
    86 00000035 52                               push edx    
    87 00000036 3D00000000                       cmp eax,0
    88 0000003B 75F0                             jne @d
    89                                  
    90                                  ;把堆栈中的数移动到message_2
    91 0000003D 66BE[1200]              	 mov si,message_2
    92                                       @b:
    93 00000041 5A                      	 pop edx
    94 00000042 678814                  	 mov [si],dl
    95 00000045 6646                    	 inc si
    96 00000047 E2F8                    	 loop @b
    97                                  ;==========================================================
    98 00000049 BB[12000000]                     mov ebx,message_2
    99 0000004E 64FF1D[28000000]                 call far [fs:PrintString]
   100                                       
   101 00000055 64FF1D[28010000]                 call far [fs:TerminateProgram]      ;退出，并将控制权返回到核心 
   102                                      
   103                                  code_end:
   104                                  
   105                                  ;-------------------------------------------------------------------------------
   106                                  SECTION trail
   107                                  ;-------------------------------------------------------------------------------
   108                                  program_end:
